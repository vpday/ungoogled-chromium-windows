name: 'Prepare Build Environment'
description: 'Checkout, install deps, setup python and npm'
inputs:
  python-version:
    description: 'Python version'
    default: '3.12'
  x86:
    description: 'Building for x86 architecture'
    required: false
    default: 'false'
runs:
  using: "composite"
  steps:
    - name: Free Disk Space (Custom Script)
      shell: bash
      run: |
        sudo rm -rf /usr/lib/jvm
        sudo rm -rf /usr/lib/dotnet
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/share/miniconda
        sudo rm -rf /usr/local/julia*
        sudo rm -rf /usr/local/aws-sam-cli
        sudo rm -rf /usr/local/aws-cli
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/lib/node_modules
        sudo rm -rf /opt/microsoft/msedge
        sudo rm -rf /opt/hostedtoolcache/go
        sudo rm -rf /opt/hostedtoolcache/Ruby
        sudo rm -rf /opt/hostedtoolcache/CodeQL

    - name: Free Disk Space
      uses: BRAINSia/free-disk-space@v2
      with:
        tool-cache: false
        mandb: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: false

    - name: Install System Dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip pkg-config libglib2.0-dev libfuse2 libfuse2t64 libnss3-dev libcups2-dev libpci-dev libdrm-dev libxkbcommon-dev gperf libkrb5-dev

    - name: Install 32-bit Development Libraries
      if: ${{ inputs.x86 == 'true' }}
      shell: bash
      run: |
        echo "Installing 32-bit development libraries for x86 cross-compilation..."
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y libc6-dev-i386 linux-libc-dev:i386 gcc-multilib g++-multilib libglib2.0-0:i386 libnss3:i386 libnspr4:i386 libatk1.0-0:i386 libatk-bridge2.0-0:i386 libcups2:i386 libdrm2:i386 libdbus-1-3:i386 libexpat1:i386

    - name: Install 7-Zip-Zstd
      shell: bash
      run: |
        wget -q https://github.com/mcmilk/7-Zip-zstd/releases/download/v25.01-v1.5.7-R4/linux-clang-x64.zip -O 7z-zstd.zip
        mkdir -p tmp_7z
        unzip -o 7z-zstd.zip -d tmp_7z
        sudo mv -f tmp_7z/* /usr/bin/
        rm -rf tmp_7z 7z-zstd.zip
        sudo chmod +x /usr/bin/7z /usr/bin/7za /usr/bin/7zr /usr/bin/7zz
        echo "7-Zip-Zstd installed version:"
        7z --version

    - name: Prepare /mnt Build Directory
      shell: bash
      run: |
        set -e

        # Create /mnt build directory with proper ownership
        STORAGE_DIR="/mnt/chromium-build"

        echo "Creating build directory: ${STORAGE_DIR}"
        sudo mkdir -p "${STORAGE_DIR}"

        # Set ownership to current user
        CURRENT_USER=$(whoami)
        CURRENT_GROUP=$(id -gn)
        echo "Setting ownership to ${CURRENT_USER}:${CURRENT_GROUP}"
        sudo chown "${CURRENT_USER}:${CURRENT_GROUP}" "${STORAGE_DIR}"

        # Set permissions
        sudo chmod 755 "${STORAGE_DIR}"

        # Verify
        echo "Directory created successfully:"
        ls -ld "${STORAGE_DIR}"

        # Test write permissions
        if touch "${STORAGE_DIR}/.write-test" 2>/dev/null; then
          echo "[PASS] Write test successful"
          rm "${STORAGE_DIR}/.write-test"
        else
          echo "[FAIL] Write test failed"
          exit 1
        fi

        echo "Get CPU Info:"
        sudo lscpu

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install Stage Dependencies
      shell: bash
      run: npm install
      working-directory: ./.github/actions/stage

    - name: Copy Workspace to /mnt
      shell: bash
      run: |
        set -e

        STORAGE_DIR="/mnt/chromium-build"

        echo "Copying workspace from ${GITHUB_WORKSPACE} to ${STORAGE_DIR}"
        cp -r "${GITHUB_WORKSPACE}/"* "${GITHUB_WORKSPACE}/".* "${STORAGE_DIR}/" 2>/dev/null || true